<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Script: Emergency - Shutdown - micronauts </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Reference script to shutdown the lab- Script: Emergency - Shutdown"> <meta name="keywords" content="Script: Emergency - Shutdown, micronauts, esx, powercli, script, vmware,"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="micronauts" property="og:site_name" /> <meta content="Script: Emergency - Shutdown" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Reference script to shutdown the lab" property="og:description" /> <meta content="http://localhost:4000/blog/script-emergency-shutdown/" property="og:url" /> <meta content="2011-01-05T00:00:00-05:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/images/2011/01/emergency-shutoff.jpg" property="og:image" /> <meta content="esx" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Script: Emergency - Shutdown" /> <meta name="twitter:url" content="http://localhost:4000/blog/script-emergency-shutdown/" /> <meta name="twitter:description" content="Reference script to shutdown the lab" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">micronauts</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/gallery" >Gallery</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch theme-toggle" type="checkbox" name="checkbox" /> </li> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Script: Emergency - Shutdown</h1> <h4 class="post-meta">Reference script to shutdown the lab</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/samui">samui</a></span> </span > on <time datetime="2011-01-05 00:00:00 -0500" itemprop="datePublished" >Jan 5, 2011</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/script-emergency-shutdown/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/esx" >esx</a > &nbsp; <a href="/blog/categories/powercli" >powercli</a > &nbsp; <a href="/blog/categories/script" >script</a > &nbsp; <a href="/blog/categories/vmware" >vmware</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/images/2011/01/emergency-shutoff.jpg" alt="" /> <br /> <br /> <p>Recently I had a vSphere 4.0 U1 environment experience a major outage. I had to bring down our entire environment consisting of 242 guests and 6 hosts. I knew that I had a bash script that I wrote for a 3.5 environment for this scenario, but due to logistical reasons it was unavailable. I had to come up with a quick solution as everyone was waiting on me.</p> <p>A quick search on a site that is becoming a favorite of mine found me a <a href="http://www.virtu-al.net/2010/01/06/powercli-shutdown-your-virtual-infrastructure/">solution</a> that I could run in powercli. Alan Renouf created this script. (Thank you Alan.) After the outage, I took another look at his script and wanted to add a few other touches to it - specifically a warning screen with a way to safely stop the script before starting to shutdown VMs. Since I will be sharing this script with co-workers, I needed a way for them to stop the script if they accidentally started running it by mistake.</p> <p>I am running the following revised script in PowerCLi version 4.1.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@"
===============================================================================
Title: 			SHUTDOWN v2.7
Created:		Alan Renouf
Modified by:	J. Sam Aaron 	12/24/2010
Description: 	Shutsdown all VMs and then the ESX Server
Requirements: 	Windows Powershell and the VI Toolkit
Usage:			.\shutdown.ps1
===============================================================================
"@

# Add the VI-Snapin if it isn't loaded already
if ( (Get-PSSnapin -Name "VMware.VimAutomation.Core" -ErrorAction SilentlyContinue) -eq $null )
	{
	Add-PSSnapin -Name "VMware.VimAutomation.Core"
	}

# Variables
Write-Host
$vc = Read-Host "Enter the ESX IP Address"
$VIServer = Connect-VIServer -Server $vc

# vc had some timeouts so retry...
if ($null -eq $VIServer) {
    write-host "Retrying Connect to "$vc
	$VIServer = Connect-VIServer -Server $vc
	}

# Warning Notice
$input = ""
clear
Write-Host "Connected to" $vc
Write-Host
Write-Host "==============================================================================="
Write-Host "===                                                                         ==="
Write-Host "===       WARNING!     WARNING!     WARNING!     WARNING!     WARNING!      ==="
(New-Object -ComObject sapi.spvoice).speak("WARNING! WARNING! WARNING!") | Out-Null
Write-Host "===                                                                         ==="
Write-Host "==============================================================================="
Write-Host
Write-Host "  This script is designed to power off all virtual machines and the ESX host."
Write-Host
Write-Host
$input = Read-Host "  TYPE 'NO' TO STOP THIS SCRIPT AND EXIT NOW."
if ($input -eq "no") {
	 Write-Host
	 Write-Host "==============================================================================="
	 Write-Host "===               THE SHUTDOWN PROCESS HAS BEEN CANCELLED.                  ==="
	 Write-Host "==============================================================================="
	 exit
	}
Write-Host
Write-Host "==============================================================================="
Write-Host "===                    THE SHUTDOWN PROCESS WILL RESUME.                    ==="
Write-Host "==============================================================================="

#Get All the ESX Hosts
$ESXSRV = Get-VMHost
#$ESXSRV = Get-Cluster "Cluster Name" | Get-VMHost
#$ESXSRV = Get-DataCenter “DC1” | Get-VMHost

# For each of the VMs on the ESX hosts
Foreach ($VM in ($ESXSRV | Get-VM | Where { $_.PowerState -eq “poweredOn” } )){
     # Shutdown the guest cleanly
     $VM | Shutdown-VMGuest -Confirm:$false | Out-Null
	 Write-Host
	 Write-Host $VM "is Powering Down"
	}

# Set the amount of time to wait before assuming the remaining powered on guests are stuck
$waittime = 60 #Seconds
$Time = (Get-Date).TimeofDay
 do {
	 # Wait for the VMs to be Shutdown cleanly
	 sleep 1.0
	 $timeleft = $waittime - ($Newtime.seconds)
	 $numvms = ($ESXSRV | Get-VM | Where { $_.PowerState -eq "poweredOn" }).Count
	 write-host
	 Write "  Waiting for shutdown of $numvms VMs or until $timeleft seconds"
	 $Newtime = (Get-Date).TimeofDay - $Time
	 } until ((@($ESXSRV | Get-VM | Where { $_.PowerState -eq "poweredOn" }).Count) -eq 0 -or $timeleft -eq 0) 

# Force VMs off
Foreach ($VM in ($ESXSRV | Get-VM | Where { $_.PowerState -eq “poweredOn” } )){
	 $VM | Stop-VM -Confirm:$false | Out-Null
	 Write-Host
	 Write-Host $VM "has been Powered Off"
	}

# Timer to delay Maintenance Mode
$waittime = 20 #Seconds
$Time = (Get-Date).TimeofDay
 do {
	 sleep 1.0
	 $timeleft = $waittime - ($Newtime.seconds)
	 $Newtime = (Get-Date).TimeofDay - $Time
	} until (($Newtime).Seconds -ge $waittime)

# Place ESX in Maintenance Mode
$ESXSRV | Set-VMHost -State Maintenance | Out-Null
Write-Host
Write-Host   $vc "is in Maintenance Mode"

# Shutdown the ESX Hosts
$ESXSRV | Foreach {Get-View $_.ID} | Foreach {$_.ShutdownHost_Task($TRUE)} | Out-Null
Write-Host
Write-Host "==============================================================================="
Write-Host "===                  THE SHUTDOWN PROCESS HAS COMPLETED.                    ==="
Write-Host "==============================================================================="

# Disconnect from the ESX Server
Write-Host
Disconnect-VIServer -Server $vc -Confirm:$False
Write-Host "  Disconnected from" $vc

#######################################################################
# Changes:
# Version 2.7 - Added the ability to stop the shutdown during the warning
# Version 2.6 - Added Delay for Maintenance Mode
# Version 2.5 - Added Warning Notice
# Version 2.4 - Added Force stop
# Version 2.3 - Fixed Bug in Time: Adjusted waittime to 60 seconds
# Version 2.2 - Added Maintenance Mode
# Version 2.1 - Added a line to print that the VM was powered off
# Version 2.0 - Cleaned up Script
# Version 1.9 - Added Prompt for Host
# Version 1.8 - Added Sanity Check for PSSnapin
# Version 1.7 - Added Countdown timer
# Version 1.6 - Added Sanity Check on VM State
# Version 1.5 - Added VC Disconnection
# Version 1.4 - Added VC Connection
# Version 1.3 - Added VM Shutdown
# Version 1.2 - Added Title Sequence
# Version 1.1 - Added PSSnapin
# Version 1.0 - Initial Creation

</code></pre></div></div> <p><strong>A few words of caution: Run this script in a fresh powercli or powershell window. If connecting to vCenter, this script will contact EVERY ESX host and start shutting down ALL VMs. If you need to shut down specific VMs on an ESX server, then connect to that server individually. Or comment out LINE 58 and uncomment LINE 59 or 60 for the specific Cluster or Datacenter that you need powered off.</strong></p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/script-emergency-shutdown/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Sam Aaron </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/samui.png" alt="Sam Aaron" /> </div> <div class="col-md-6"> <p class="author_bio">Father, Husband, Geek. Workaholic.</p> <p>Email : mail@micronauts.us</p> <p>Website : http://micronauts.us</p> <p class="profile-links"> <a class="social-link" href="https://github.com/jedisamui" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/j.sam.aaron" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/script-emergency-shutdown/"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/script-emergency-shutdown"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Sam Aaron</div> <div class="card-body"> <p class="author_bio">Father. Husband. Geek. Workaholic.</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/sujaykundu777/devlopr-jekyll" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star sujaykundu777/devlopr-jekyll on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#esx"></div> <li class="tag-head"> <a href="/blog/categories/esx">esx</a> </li> <a name="esx"></a> <div id="#vmware"></div> <li class="tag-head"> <a href="/blog/categories/vmware">vmware</a> </li> <a name="vmware"></a> <div id="#linux"></div> <li class="tag-head"> <a href="/blog/categories/linux">linux</a> </li> <a name="linux"></a> <div id="#vmtools"></div> <li class="tag-head"> <a href="/blog/categories/vmtools">vmtools</a> </li> <a name="vmtools"></a> <div id="#p2v"></div> <li class="tag-head"> <a href="/blog/categories/p2v">p2v</a> </li> <a name="p2v"></a> <div id="#commandline"></div> <li class="tag-head"> <a href="/blog/categories/commandline">commandline</a> </li> <a name="commandline"></a> <div id="#vmnic"></div> <li class="tag-head"> <a href="/blog/categories/vmnic">vmnic</a> </li> <a name="vmnic"></a> <div id="#solaris"></div> <li class="tag-head"> <a href="/blog/categories/solaris">solaris</a> </li> <a name="solaris"></a> <div id="#ssh"></div> <li class="tag-head"> <a href="/blog/categories/ssh">ssh</a> </li> <a name="ssh"></a> <div id="#script"></div> <li class="tag-head"> <a href="/blog/categories/script">script</a> </li> <a name="script"></a> <div id="#daily"></div> <li class="tag-head"> <a href="/blog/categories/daily">daily</a> </li> <a name="daily"></a> <div id="#dos"></div> <li class="tag-head"> <a href="/blog/categories/dos">dos</a> </li> <a name="dos"></a> <div id="#lab"></div> <li class="tag-head"> <a href="/blog/categories/lab">lab</a> </li> <a name="lab"></a> <div id="#project"></div> <li class="tag-head"> <a href="/blog/categories/project">project</a> </li> <a name="project"></a> <div id="#network"></div> <li class="tag-head"> <a href="/blog/categories/network">network</a> </li> <a name="network"></a> <div id="#powercli"></div> <li class="tag-head"> <a href="/blog/categories/powercli">powercli</a> </li> <a name="powercli"></a> <div id="#troubleshooting"></div> <li class="tag-head"> <a href="/blog/categories/troubleshooting">troubleshooting</a> </li> <a name="troubleshooting"></a> <div id="#vcenter"></div> <li class="tag-head"> <a href="/blog/categories/vcenter">vcenter</a> </li> <a name="vcenter"></a> <div id="#windows"></div> <li class="tag-head"> <a href="/blog/categories/windows">windows</a> </li> <a name="windows"></a> <div id="#vmware-kb"></div> <li class="tag-head"> <a href="/blog/categories/vmware-kb">vmware-kb</a> </li> <a name="vmware-kb"></a> <div id="#howto"></div> <li class="tag-head"> <a href="/blog/categories/howto">howto</a> </li> <a name="howto"></a> <div id="#powershell"></div> <li class="tag-head"> <a href="/blog/categories/powershell">powershell</a> </li> <a name="powershell"></a> <div id="#storage"></div> <li class="tag-head"> <a href="/blog/categories/storage">storage</a> </li> <a name="storage"></a> <div id="#netapp"></div> <li class="tag-head"> <a href="/blog/categories/netapp">netapp</a> </li> <a name="netapp"></a> <div id="#tools"></div> <li class="tag-head"> <a href="/blog/categories/tools">tools</a> </li> <a name="tools"></a> <div id="#svmotion"></div> <li class="tag-head"> <a href="/blog/categories/svmotion">svmotion</a> </li> <a name="svmotion"></a> <div id="#vcloud"></div> <li class="tag-head"> <a href="/blog/categories/vcloud">vcloud</a> </li> <a name="vcloud"></a> <div id="#vra"></div> <li class="tag-head"> <a href="/blog/categories/vra">vra</a> </li> <a name="vra"></a> <div id="#automation"></div> <li class="tag-head"> <a href="/blog/categories/automation">automation</a> </li> <a name="automation"></a> <div id="#vcloud-director"></div> <li class="tag-head"> <a href="/blog/categories/vcloud-director">vcloud-director</a> </li> <a name="vcloud-director"></a> <div id="#tips"></div> <li class="tag-head"> <a href="/blog/categories/tips">tips</a> </li> <a name="tips"></a> <div id="#nsx"></div> <li class="tag-head"> <a href="/blog/categories/nsx">nsx</a> </li> <a name="nsx"></a> <div id="#jekyll"></div> <li class="tag-head"> <a href="/blog/categories/jekyll">jekyll</a> </li> <a name="jekyll"></a> <div id="#guides"></div> <li class="tag-head"> <a href="/blog/categories/guides">guides</a> </li> <a name="guides"></a> <div id="#sample_category"></div> <li class="tag-head"> <a href="/blog/categories/sample_category">sample_category</a> </li> <a name="sample_category"></a> <div id="#github"></div> <li class="tag-head"> <a href="/blog/categories/github">github</a> </li> <a name="github"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/gallery">Gallery</a> </li> </div> </div> </div> </div> </div><footer> <p> Hosted with <a href="https://pages.github.com">Github Pages</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>
