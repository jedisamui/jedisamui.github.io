<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> vRA 8.3 IPAM integration using phpipam and ABX - Part 2 - micronauts </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="Releasing the IP Address from phpipam- vRA 8.3 IPAM integration using phpipam and ABX - Part 2"> <meta name="keywords" content="vRA 8.3 IPAM integration using phpipam and ABX - Part 2, micronauts, lab, howto, project, script, vra, automation,"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="micronauts" property="og:site_name" /> <meta content="vRA 8.3 IPAM integration using phpipam and ABX - Part 2" property="og:title" /> <meta content="article" property="og:type" /> <meta content="Releasing the IP Address from phpipam" property="og:description" /> <meta content="http://localhost:4000/blog/vra-83-ipam-integration-using-phpipam-and-abx-part-2" property="og:url" /> <meta content="2021-03-18T00:00:00-04:00" property="article:published_time" /> <meta content="http://localhost:4000/about/" property="article:author" /> <meta content="http://localhost:4000/images/2021/03/855114-ipam.RZ.png" property="og:image" /> <meta content="lab" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="vRA 8.3 IPAM integration using phpipam and ABX - Part 2" /> <meta name="twitter:url" content="http://localhost:4000/blog/vra-83-ipam-integration-using-phpipam-and-abx-part-2" /> <meta name="twitter:description" content="Releasing the IP Address from phpipam" /> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://localhost:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://localhost:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://localhost:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://localhost:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://localhost:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://localhost:4000/assets/js/mode-switcher.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://localhost:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://localhost:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://localhost:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://localhost:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://localhost:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://localhost:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://localhost:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://localhost:4000/assets/js/search.js"></script> <script src="http://localhost:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">micronauts</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/gallery" >Gallery</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link" href="http://localhost:4000/styleguide"> Styleguide </a> </li> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch theme-toggle" type="checkbox" name="checkbox" /> </li> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">vRA 8.3 IPAM integration using phpipam and ABX - Part 2</h1> <h4 class="post-meta">Releasing the IP Address from phpipam</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://localhost:4000/blog/authors/samui">samui</a></span> </span > on <time datetime="2021-03-18 00:00:00 -0400" itemprop="datePublished" >Mar 18, 2021</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/vra-83-ipam-integration-using-phpipam-and-abx-part-2" ></span> <div class="post-categories"> Category : <a href="/blog/categories/lab" >lab</a > &nbsp; <a href="/blog/categories/howto" >howto</a > &nbsp; <a href="/blog/categories/project" >project</a > &nbsp; <a href="/blog/categories/script" >script</a > &nbsp; <a href="/blog/categories/vra" >vra</a > &nbsp; <a href="/blog/categories/automation" >automation</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://localhost:4000/images/2021/03/855114-ipam.RZ.png" alt="" /> <br /> <br /> <p>Continuing the work on the phpipam integration with vRA from Part 1, this post will walk you through what I did to “unwind” the process. Or rather, the retirement and recovery of IP Address(es).</p> <h2 id="use-case-review">Use Case Review</h2> <p>Let’s review the use case once more. I wanted to automatically allocate and assign the next free IP address in a subnet and then release the IP address(es) during the decommissioning of a workload.</p> <h2 id="abx-action">ABX Action</h2> <p>Part 1 focused on the efforts to get some borrowed code to fulfill the first portion of the use case: “to automatically allocate and assign the next free IP address in a subnet.” If you remember, I borrowed Robert Jensen’s code from the VMware code site. And for the most part, we are not changing the ‘destroy’ portion of the code.</p> <p>I created a new ABX Action and again, used <a href="https://code.vmware.com/en/samples/7270/phpipam-integration-with-vra-8-x#" target="_blank">Robert Jensen’s code</a> as my base and adding some cleanup it looks like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import requests
import json

#Global Variables
phpipamhost   = "&lt;phpipam FQDN&gt;"                          #PHPIpam Host
ipadress      = ""                                          #Cleaned up IP
subnetid      = ""                                          #Subnetid Calculated later from IPadress
app           = "vmware"                                    #PHPmyipam API App Name
app_token     = "&lt;enter your phpipam api code&gt;"          #PHPmyipam API App Token
token         = ""                                          #Generated auth token
response      = ""                                          #Response - not used yet.

# =======(Remove this comment block)===========
# I had to modify the IF/Then comparison so that 
# the line would work in this version. Before the change, 
# Robert's code would not resolve to true and therefore
# would not return the subnetid value. Performing a 'find'
# allowed the statement to resolve to a boolean value.
# =======(Remove this comment block)===========

#Get subnet identifier
def get_subnetid(context, inputs, ipadress):
    global subnetid

    #print (ipadress)

    if ipadress.find('192.168.14') &gt;= 0 :
      subnetid = "17"
    
    if ipadress.find('192.168.16') &gt;= 0 :
      subnetid = "18"
      
    if ipadress.find('192.168.18') &gt;= 0 :
      subnetid = "19"

    print ("     - SUBNET ID OBTAINED......"+ subnetid)

# =======(Remove this comment block)===========
# The only change here was made to add the static token. 
# I no longer need to authenticate to get the token. 
# =======(Remove this comment block)===========

#Delete VM info
def delete_vm(context, inputs, ipadress):
    url = "https://"+phpipamhost+"/api/"+app+"/addresses/"+ipadress+"/"+subnetid+""
    headers = {
     'Content-Type': 'application/json',
     'token': ''+app_token+''
    }
    response = requests.request("DELETE", url, headers=headers, verify=False )
   
#Main Function
def handler(context, inputs):

    print (" IPAM FUNCTION RUNNING.........")
    ip_raw =  (inputs["addresses"])
    ipadress = str(ip_raw[0])[2:-2] 
    
    print ("\n PROCCESSING VM................")
    print ("     - "+ipadress)

    print (" GET SUBNET ID.................")
    get_subnetid(context, inputs, ipadress)
        
    delete_vm(context, inputs, ipadress)
    print (" RELEASING IP ADDRESS..........")

</code></pre></div></div> <p>The dependencies are only “requests”.</p> <p><img src="/images/2021/03/Screen-Shot-2021-03-18-at-4.05.07-PM.png" alt="" /></p> <h2 id="subscription">Subscription</h2> <p>A major change that I did to Robert’s example, is I broke up the code to run during specific Events. If you recall in Part 1, we set up an Event Subscription to perform the IP Allocation during the “compute.provision” state. For the IP Release, I created a new Event Subscription to perform the above action during “compute.removal”.</p> <p><img src="/images/2021/03/Screen-Shot-2021-03-18-at-4.12.29-PM.png" alt="" /></p> <h2 id="action-runs">Action Runs</h2> <p>When the action runs, the Console Log has a clean report of what is occurring.</p> <p><img src="/images/S2021/03/creen-Shot-2021-03-18-at-4.05.50-PM.png" alt="" /></p> <p>You may notice that the action will run for each VM that is being destroyed. If there are multiple virtual machines, then you may notice a different action run for each machine. In the pictured example, notice there are two different action runs for IPAM Release.</p> <p><img src="/images/2021/03/Screen-Shot-2021-03-18-at-4.07.49-PM.png" alt="" /></p> <h2 id="summary">Summary</h2> <p>With this action in place, I have met the requirements of my use case. I now have the ability to allocate and assign the next available free IP address(es) during provisioning - as well, as release the IP addresses when a virtual machine is destroyed/retired/decommissioned.</p> <p>Granted, this was just a small sampling of what can be done with IPAM integration. But I wanted to get basic IPAM functionality working in my homelab, and I can mark this “completed.”</p> <p>If you need more for your environment, I would encourage you to research and explore suitable DDI alternatives for your needs.</p> <p>As with everything, your milage will vary by trying to adapt a blog post to your scenario.</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://localhost:4000/blog/vra-83-ipam-integration-using-phpipam-and-abx-part-2" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> <div class="card"> <div class="card-header"> About Sam Aaron </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="http://localhost:4000/assets/img/authors/samui.png" alt="Sam Aaron" /> </div> <div class="col-md-6"> <p class="author_bio">Father, Husband, Geek. Workaholic.</p> <p>Email : mail@micronauts.us</p> <p>Website : http://micronauts.us</p> <p class="profile-links"> <a class="social-link" href="https://github.com/jedisamui" target="_blank"><i class="fab fa-github fa-fw"></i></a> <a class="social-link" href="https://www.linkedin.com/in/j.sam.aaron" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a> </p> </div> </div> </div> </div> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <script> var disqus_config = function () { this.page.url = "http://localhost:4000/blog/vra-83-ipam-integration-using-phpipam-and-abx-part-2"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/vra-83-ipam-integration-using-phpipam-and-abx-part-2"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Sam Aaron</div> <div class="card-body"> <p class="author_bio">Father. Husband. Geek. Workaholic.</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/sujaykundu777/devlopr-jekyll" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star sujaykundu777/devlopr-jekyll on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#esx"></div> <li class="tag-head"> <a href="/blog/categories/esx">esx</a> </li> <a name="esx"></a> <div id="#vmware"></div> <li class="tag-head"> <a href="/blog/categories/vmware">vmware</a> </li> <a name="vmware"></a> <div id="#linux"></div> <li class="tag-head"> <a href="/blog/categories/linux">linux</a> </li> <a name="linux"></a> <div id="#vmtools"></div> <li class="tag-head"> <a href="/blog/categories/vmtools">vmtools</a> </li> <a name="vmtools"></a> <div id="#p2v"></div> <li class="tag-head"> <a href="/blog/categories/p2v">p2v</a> </li> <a name="p2v"></a> <div id="#commandline"></div> <li class="tag-head"> <a href="/blog/categories/commandline">commandline</a> </li> <a name="commandline"></a> <div id="#vmnic"></div> <li class="tag-head"> <a href="/blog/categories/vmnic">vmnic</a> </li> <a name="vmnic"></a> <div id="#solaris"></div> <li class="tag-head"> <a href="/blog/categories/solaris">solaris</a> </li> <a name="solaris"></a> <div id="#ssh"></div> <li class="tag-head"> <a href="/blog/categories/ssh">ssh</a> </li> <a name="ssh"></a> <div id="#script"></div> <li class="tag-head"> <a href="/blog/categories/script">script</a> </li> <a name="script"></a> <div id="#daily"></div> <li class="tag-head"> <a href="/blog/categories/daily">daily</a> </li> <a name="daily"></a> <div id="#dos"></div> <li class="tag-head"> <a href="/blog/categories/dos">dos</a> </li> <a name="dos"></a> <div id="#lab"></div> <li class="tag-head"> <a href="/blog/categories/lab">lab</a> </li> <a name="lab"></a> <div id="#project"></div> <li class="tag-head"> <a href="/blog/categories/project">project</a> </li> <a name="project"></a> <div id="#network"></div> <li class="tag-head"> <a href="/blog/categories/network">network</a> </li> <a name="network"></a> <div id="#powercli"></div> <li class="tag-head"> <a href="/blog/categories/powercli">powercli</a> </li> <a name="powercli"></a> <div id="#troubleshooting"></div> <li class="tag-head"> <a href="/blog/categories/troubleshooting">troubleshooting</a> </li> <a name="troubleshooting"></a> <div id="#vcenter"></div> <li class="tag-head"> <a href="/blog/categories/vcenter">vcenter</a> </li> <a name="vcenter"></a> <div id="#windows"></div> <li class="tag-head"> <a href="/blog/categories/windows">windows</a> </li> <a name="windows"></a> <div id="#vmware-kb"></div> <li class="tag-head"> <a href="/blog/categories/vmware-kb">vmware-kb</a> </li> <a name="vmware-kb"></a> <div id="#howto"></div> <li class="tag-head"> <a href="/blog/categories/howto">howto</a> </li> <a name="howto"></a> <div id="#powershell"></div> <li class="tag-head"> <a href="/blog/categories/powershell">powershell</a> </li> <a name="powershell"></a> <div id="#storage"></div> <li class="tag-head"> <a href="/blog/categories/storage">storage</a> </li> <a name="storage"></a> <div id="#netapp"></div> <li class="tag-head"> <a href="/blog/categories/netapp">netapp</a> </li> <a name="netapp"></a> <div id="#tools"></div> <li class="tag-head"> <a href="/blog/categories/tools">tools</a> </li> <a name="tools"></a> <div id="#svmotion"></div> <li class="tag-head"> <a href="/blog/categories/svmotion">svmotion</a> </li> <a name="svmotion"></a> <div id="#vcloud"></div> <li class="tag-head"> <a href="/blog/categories/vcloud">vcloud</a> </li> <a name="vcloud"></a> <div id="#vra"></div> <li class="tag-head"> <a href="/blog/categories/vra">vra</a> </li> <a name="vra"></a> <div id="#automation"></div> <li class="tag-head"> <a href="/blog/categories/automation">automation</a> </li> <a name="automation"></a> <div id="#vcloud-director"></div> <li class="tag-head"> <a href="/blog/categories/vcloud-director">vcloud-director</a> </li> <a name="vcloud-director"></a> <div id="#tips"></div> <li class="tag-head"> <a href="/blog/categories/tips">tips</a> </li> <a name="tips"></a> <div id="#nsx"></div> <li class="tag-head"> <a href="/blog/categories/nsx">nsx</a> </li> <a name="nsx"></a> <div id="#jekyll"></div> <li class="tag-head"> <a href="/blog/categories/jekyll">jekyll</a> </li> <a name="jekyll"></a> <div id="#guides"></div> <li class="tag-head"> <a href="/blog/categories/guides">guides</a> </li> <a name="guides"></a> <div id="#sample_category"></div> <li class="tag-head"> <a href="/blog/categories/sample_category">sample_category</a> </li> <a name="sample_category"></a> <div id="#github"></div> <li class="tag-head"> <a href="/blog/categories/github">github</a> </li> <a name="github"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://localhost:4000/">Home</a> </li> <li> <a href="http://localhost:4000/about">About</a> </li> <li> <a href="http://localhost:4000/blog">Blog</a> </li> <li> <a href="http://localhost:4000/gallery">Gallery</a> </li> </div> </div> </div> </div> </div><footer> <p> Hosted with <a href="https://pages.github.com">Github Pages</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>
